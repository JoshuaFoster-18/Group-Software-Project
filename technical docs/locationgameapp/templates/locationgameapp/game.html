<html>
    <style>
    img.huechange { filter: hue-rotate(120deg); }
    </style>
    <head>
        <!-- Bootstrap-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        
        <!-- Leaflet-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""/>

        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      </head>

    <body>
        <!--Navigation Bar-->
        <nav class="navbar navbar-expand-md navbar-dark bg-primary">
            <a class="navbar-brand">üêå</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu">
              <span class="navbar-toggler-icon"></span>
            </button>
          
            <div class="collapse navbar-collapse" id="navbarMenu">
              <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                  <a class="nav-link" href="#leaderboardModal" data-bs-toggle="modal" data-target="#leaderboardModal">Leaderboard</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#profileModal" data-bs-toggle="modal" data-target="#profileModal">Profile</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#settingsModal" data-bs-toggle="modal" data-target="#settingsModal">Settings</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#tcModal" data-bs-toggle="modal" data-target="#tcModel">How To Play</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout">Logout</a>
                </li>
              </ul>
            </div>
          </nav>

      
        <!--Leaderboard Modal-->
        <div class="modal fade" id="leaderboardModal">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content"> 
                <div class="modal-header">
                    <h3 class="col-12 modal-title text-center">Leaderboard</h3> 
                </div>
                <div class="modal-body text-center">
                </div>
            </div>
          </div>
        </div> 


        <!--Profile Modal-->
        <div class="modal fade" id="profileModal">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content"> 
                <div class="modal-header">
                    <h3 class="col-12 modal-title text-center">Profile</h3> 
                </div>
                <div class="modal-body text-center">
                </div>
            </div>
          </div>
        </div> 


        <!--Settings Modal-->
        <div class="modal fade" id="settingsModal">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content"> 
                <div class="modal-header">
                    <h3 class="col-12 modal-title text-center">Settings</h3> 
                </div>
                <div class="modal-body text-center">
                  <button class="w-50 btn btn-lg btn-primary">Difficulty</button>
                  <br>
                  <br>
                  <button class="w-50 btn btn-lg btn-primary">Policies</button>
                  <br>
                  <br>
                  <button class="w-50 btn btn-lg btn-danger">Report Player</button>
                  <br>
                  <br>
                  <br>
                  <div class="modal-header">
                    <h3 class="col-12 modal-title text-center">Admin Options</h3>
                  </div>
                  <br>
                  <button class="w-50 btn btn-lg btn-primary">Add Tasks</button>
                  <br>
                  <br>
                  <button class="w-50 btn btn-lg btn-primary">Alter Difficulty</button>
                  <br>
                  <br>
                  <button class="w-50 btn btn-lg btn-primary">Link To Github</button>
                  <br>
                  <br>
                  <button class="w-50 btn btn-lg btn-danger">Adjust Banned Accounts</button>
                </div>
            </div>
          </div>
        </div>
        
        <!--T&C Modal-->
        <div class="modal fade" id="tcModal">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content"> 
                <div class="modal-header">
                    <h3 class="col-12 modal-title text-center">Terms and Conditions</h3> 
                </div>
                <div class="modal-body text-center">

                </div>
            </div>
          </div>
      </div>
        <!--How To Play Modal-->
        <div class="modal fade" id="howToPlayModal">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content"> 
                <div class="modal-header">
                    <h3 class="col-12 modal-title text-center">How To Play</h3> 
                </div>
                <div class="modal-body text-center">
                </div>
            </div>
          </div>
        </div>


        <div class="text-center">
            <br>
            <h1>The Snail Game üêå</h1>
            <br>
            <div id="map" style="height: 75vh;">
            	<!--Map Functionality-->
              <script>
              function getPlayerLocation() {
                //Player Location
                if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition(function(position) {
  
                    //Players current coordinates
                    const coords = [position.coords.latitude, position.coords.longitude];
                    playerCoords = coords;
  
                    //Remove previous player location marker
                    if (playerLocation){
                      map.removeLayer(playerLocation);
                    }
                    //Player location marker creation
                    playerLocation = L.marker([coords[0],coords[1]]).addTo(map);
                    playerLocation.bindPopup("Your location");
                    playerLocation._icon.classList.add("huechange");
                    //console.log("updated player")
                  });
                }   
                //Player location not supported             
                else { 
                  alert("Geolocation is not supported by this browser.");
                }
              }
  
              function updateSnailLocation() {
                //Snail update
                if (navigator.geolocation) {
                  //Remove previous snail location marker
                  if (snailLocation){
                    map.removeLayer(snailLocation);
                    //moving the snail location closer to the player location
                    latDist = Math.sqrt((playerCoords[0] - snailCoords[0])**2);
                    longDist = Math.sqrt((playerCoords[1] - snailCoords[1])**2);
                    //temporary snail found
                    if (latDist < 0.00001 && longDist < 0.00001){
                      alert("Found")
                    }

                    euclDist = Math.sqrt((latDist)**2 + (longDist)**2);
                    //working out how far to move in long and lat
                    ratio = euclDist/speed;
                    if ((playerCoords[0] - snailCoords[0]) < 0){
                      snailCoords[0] = snailCoords[0]-(latDist/ratio);
                    } else {
                      snailCoords[0] = snailCoords[0]+(latDist/ratio);
                    }

                    if ((playerCoords[1] - snailCoords[1]) < 0){
                      snailCoords[1] = snailCoords[1]-(longDist/ratio);
                    } else {
                      snailCoords[1] = snailCoords[1]+(longDist/ratio);
                    }

                    snailLocation = L.marker([snailCoords[0],snailCoords[1]],{icon: snailIcon}).addTo(map);
                    snailLocation.bindPopup("Snail");
                  } else {
                    //Snail location marker creation
                    if (playerLocation){
                      snailCoords = [playerCoords[0]+distance,playerCoords[1]+distance];
                      snailLocation = L.marker([snailCoords[0],snailCoords[1]],{icon: snailIcon}).addTo(map);
                      snailLocation.bindPopup("Snail");
                    }
                  }
                  //console.log("updated snail");
                }   
                //Location not supported             
                else { 
                  alert("Geolocation is not supported by this browser.");
                }
              }
  
              //Centers map on Exeter University
              var map = L.map('map').setView([50.736391, -3.533999], 16);
              var playerLocation;
              var playerCoords;
              var snailLocation;
              var snailCoords;
              //How far away from the player the snail will spawn
              var distance = 0.005;
              //How fast the snail will move (smaller is faster)
              var speed = 0.0002;
              
              //getting the icon for the snail as an image from the internet and formatting its size
              var snailIcon = L.icon({
                iconUrl: 'https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/320/apple/114/snail_1f40c.png',
                iconSize: [40, 40]
              });
  
              //Map implementation
              L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
              attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery ¬© <a href="https://www.mapbox.com/">Mapbox</a>',
              maxZoom: 26,
              id: 'mapbox/streets-v11',
              tileSize: 512,
              zoomOffset: -1,
              accessToken: 'pk.eyJ1IjoiY3c4NjMiLCJhIjoiY2wwM3JvNTdrMGFtaTNlcGRidG05MzUwOSJ9.WHpNIG8lsRUY9FptsF6jFw'
              }).addTo(map);
  
              //Adding tasks from database
              let taskLocations = JSON.parse("{{ tasks|escapejs }}");
  
              //Cycle through the tasks
              for (let taskLocation of taskLocations) { 
                  let coordinates = [taskLocation.longitude, taskLocation.latitude]; 
                  let description = [taskLocation.description];
  
                  //Add mask to the map
                  var marker = L.marker([coordinates[0],coordinates[1]]).addTo(map);
                  map.addLayer(marker);
  
                  //Set popup description
                  marker.bindPopup(description[0]);
              }
  
              //Gets the player location
              function callPosition(){
                //updating the player location, to track the player moving
                getPlayerLocation();
                //updating the snail location to get closer to the player
                updateSnailLocation();
                //calls the get location every 2000milliseconds (2 seconds)
                setTimeout(callPosition, 2000);
                //console.log("updated both")
              }
              
              callPosition();
              </script>
            </div>
            
            <!-- Bootstrap js -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        </div>
    </body>
</html>
